# [WIP] Fazendo deploy no Fly.io e configurando o PostgreSQL

Aula em manuten√ß√£o. Discuss√µes no t√≥pico de manuten√ß√£o na issue [#58](https://github.com/dunossauro/fastapi-do-zero/issues/58){:target="_blank"} do reposit√≥rio.

---

**Objetivos da aula:**

- Entender o que √© o Fly.io e como instalar sua CLI
- Aprender a fazer o deploy de uma aplica√ß√£o Docker no Fly.io
- Configurar uma inst√¢ncia do PostgreSQL no Fly.io
- Configurar as vari√°veis de ambiente
- Rodar as migra√ß√µes do Alembic
- Configurar o deploy cont√≠nuo no Github Actions

---

Agora que temos uma API criada com integra√ß√£o ao banco de dados e testes sendo executados via integra√ß√£o cont√≠nua. Chegou a t√£o esperada hora de colocar nossa aplica√ß√£o em produ√ß√£o para que todas as pessoas possam acess√°-la. Colacaremos nossa aplica√ß√£o em produ√ß√£o usando um servi√ßo de [PaaS](https://pt.wikipedia.org/wiki/Plataforma_como_servi%C3%A7o){:target="_blank"}, chamado [Fly.io](https://fly.io){:target="_blank"}.


## O Fly.io

O Fly.io √© uma plataforma de deploy que nos permite lan√ßar nossas aplica√ß√µes na nuvem e que oferece servi√ßos para diversas linguagens de programa√ß√£o e frameworks como Python e Django, PHP e Laravel, Ruby e Rails, Elixir e Phoenix, etc. 

Ao mesmo tempo, em que permite que o deploy de aplica√ß√µes em containers docker tamb√©m possam ser utilizadas, como √© o nosso caso. Al√©m disso, o Fly disponibiliza bancos de dados para serem usados em nossas aplica√ß√µes, como PostgreSQL e [Redis](https://redis.io/){:target="_blank"}.

O motivo pela escolha do Fly √© que ele permite que fa√ßamos deploys de aplica√ß√µes em desenvolvimento / provas de conceito de forma gratuita - o que vamos usar para "colocar nossa aplica√ß√£o no mundo".

> Para fazer o uso do fly.io √© necess√°rio que voc√™ [crie uma conta no servi√ßo](https://fly.io/app/sign-in){:target="_blank"}.


### Flyclt

Uma das formas de interagir com a plataforma √© via uma aplica√ß√£o de linha de comando disponibilizada pelo Fly, o [flyctl](https://fly.io/docs/flyctl/){:target="_blank"}.

O flyctl precisa ser instalado em seu computador. Em algumas distribui√ß√µes linux o flyctl est√° dispon√≠vel nos reposit√≥rios de aplica√ß√µes. Para Mac/Windows ou distribui√ß√µes linux que n√£o contam com o pacote no reposit√≥rio, voc√™ pode seguir o guia de [instala√ß√£o oficial](https://fly.io/docs/hands-on/install-flyctl/){:target="_blank"}.

Ap√≥s a instala√ß√£o, voc√™ pode verificar se o flyctl est√° instalado em seu sistema operacional digitando o seguinte comando no terminal:


```shell title="$ Execu√ß√£o no terminal!"
flyctl version

flyctl v0.1.134 linux/amd64 Commit: ... BuildDate: 2023-12-08T18:58:44Z
```

A vers√£o instalada no meu sistema √© a `0.1.134`. No momento da sua instala√ß√£o, voc√™ pode se deparar com uma vers√£o mais recente do que a minha no momento, mas os comandos devem funcionar da mesma forma em qualquer vers√£o menor que `0.2.0`.


#### Fazendo login via terminal

Ap√≥s a instala√ß√£o do `flyctl` √© importante que voc√™ efetue o login usando suas credenciais, para que o `flyctl` consiga vincular suas credenciais com a linha de comando. Para isso podemos executar o seguinte comando:

```shell title="$ Execu√ß√£o no terminal!"
flyctl auth login
Opening https://fly.io/app/auth/cli/91283719231023123 ...

Waiting for session...
```

Isso abrir√° uma janela em seu browser pedindo que voc√™ efetue o login:

![Captura de tela da tela inicial de login do fly.io](assets/11_auth_login_fly.png){: .center .shadow width="500" }

Ap√≥s inserir suas credenciais, voc√™ pode fechar o browser e no shell a execu√ß√£o do comando terminar√° mostrando a conta em que voc√™ est√° logado:

```shell title="$ Continua√ß√£o da resposta do terminal"
Waiting for session... Done
successfully logged in as <seu-email@de-login.com>
```

Desta forma, toda a configura√ß√£o necess√°ria para o iniciar o deploy est√° pronta!

## Configura√ß√µes para o deploy

Agora com o `flyctl` devidamente configurado. Podemos iniciar o processo de lan√ßamento da nossa aplica√ß√£o. O `flyctl` tem um comando espec√≠fico para lan√ßamento, o `launch`. Contudo, o comando `launch` √© bastante interativo e ao final dele, o deploy da aplica√ß√£o √© executado. Para evitar o deploy no primeiro momento, pois ainda existem coisas para serem configuradas, vamos execut√°-lo da seguinte forma:

```shell title="$ Execu√ß√£o no terminal!"
flyctl launch --no-deploy
```

Como resultado desse comando, o `flyctl` iniciar√° o modo interativo e exibir√° uma resposta pr√≥xima a essa:

```shell title="$ Resposta do comando `launch`"
Detected a Dockerfile app
Creating app in /home/dunossauro/ci-example-fastapi
We're about to launch your app on Fly.io. Here's what you're getting:

Organization: <Seu Nome>             (fly launch defaults to the personal org)
Name:         fast-zero              (derived from your directory name)
Region:       Sao Paulo, Brazil      (this is the fastest region for you)
App Machines: shared-cpu-1x, 1GB RAM (most apps need about 1GB of RAM)
Postgres:     <none>                 (not requested)
Redis:        <none>                 (not requested)

? Do you want to tweak these settings before proceeding? (y/N) 
```

Nesse texto est√£o destacadas as configura√ß√µes padr√µes do Fly. Como a Regi√£o onde seu deploy ser√° feito (`Sao Paulo, Brazil`, o mais pr√≥ximo a mim nesse momento), a configura√ß√£o da m√°quina do deploy `App Machines: shared-cpu-1x, 1GB RAM` e a op√ß√£o padr√£o do Postgres: `Postgres: <none>`.

A pergunta feita ao final dessa se√ß√£o `Do you want to tweak these settings before proceeding?` pode ser traduzida como: `Voc√™ deseja ajustar essas configura√ß√£o antes de prosseguir?`. Diremos que sim, digitando ++y++ e em seguida ++return++.

Assim, a configura√ß√£o do lan√ßamento deve avan√ßar e travar novamente com um texto parecido com esse:

```shell title="$ Continua√ß√£o do comando `launch`"
? Do you want to tweak these settings before proceeding? Yes
Opening https://fly.io/cli/launch/59f08b31a5efd30bdf5536ac516de5ga ...

Waiting for launch data...‚£Ω
```

Nesse momento, ele abrir√° o browser novamente exibira uma tela de ajustes de configura√ß√µes:

![captura de tela da janela de tweak da aplica√ß√£o](assets/11_fly_lauch_tweak.png){: .center .shadow width="500" }

Nesse momento faremos alguns ajustes em nossa configura√ß√£o:

1. Se√ß√£o `Basics`: adicionaremos o nome da nossa aplica√ß√£o no Fly. (Usarei `fastzeroapp`)
2. Se√ß√£o `Memory & CPU`: alteraremos o campo `VM Memory` para 256MB
3. Se√ß√£o `Database`:
    - alteraremos o campo `Postgres` para `Fly Postgres`
	- criaremos um nome para o nosso servi√ßo de banco de dados. (Usarei `fastzerodb`)
	- no campo `Configuration` alteraremos para `Development - Single node, 1x shared CPU, 256MB RAM, 1GB disk`
4. Por fim, clicamos em `Confirm Settings`!

Ap√≥s esse ajuste, voc√™ pode fechar a janela do browser e voltar ao terminal, pois a parte interativa do `launch` ainda estar√° em execu√ß√£o. Como a resposta a seguir √© bastante grande, colocarei `...` para pular algumas linhas que n√£o nos interessam nesse momento:

```shell title="$ Continua√ß√£o do comando `launch`" hl_lines="2 16 22"
Created app 'fastzeroapp' in organization 'personal'
Admin URL: https://fly.io/apps/fastzeroapp
Hostname: fastzeroapp.fly.dev
Creating postgres cluster in organization personal
Creating app...

...

Postgres cluster fastzerodb created
  Username:    postgres
  Password:    t0Vf35P21eDlIVS
  Hostname:    fastzerodb.internal
  Flycast:     fdaa:2:77b0:0:1::a
  Proxy port:  5432
  Postgres port:  5433
  Connection string: postgres://postgres:t0Vf35P21eDlIVS@fastzerodb.flycast:5432

...

Postgres cluster fastzerodb is now attached to fastzeroapp
The following secret was added to fastzeroapp:
  DATABASE_URL=postgres://fastzeroapp:zHgBlc6JNaslGtz@fastzerodb.flycast:5432/fastzeroapp?sslmode=disable
Postgres cluster fastzerodb is now attached to fastzeroapp
? Create .dockerignore from .gitignore files? (y/N)
```

Nas linhas em destaque, vemos que o Fly se encarregou de criar um dashboard para vermos o status atual da nossa aplica√ß√£o (https://fly.io/apps/nome-do-seu-app), inicializou um banco de dados postgres para usarmos em conjunto com nossa aplica√ß√£o e tamb√©m adicionou a url do banco de dados a vari√°vel de ambiente `DATABASE_URL` com a configura√ß√£o do postgres referente a nossa aplica√ß√£o.

**A `Connection string` do banco de dados deve ser armazenada por voc√™, essa informa√ß√£o n√£o ser√° disponibilizada novamente, nem mesmo na parte web do Fly. Por isso {++guarde-a com cuidado e n√£o compartilhem de forma alguma++}.**

Assim sendo, para prosseguir com o `launch` devemos responder a seguinte pergunta: `Create .dockerignore from .gitignore files? (y/N)`, que pode ser traduzida como `Crie um .dockerignore partindo do arquivo .gitignore?`. Vamos novamente responder que sim. Digitando ++y++ e em seguida ++return++.

```shell title="$ Continua√ß√£o do comando `launch`"
Created <seu-path>/.dockerignore from 6 .gitignore files.
Wrote config file fly.toml
Validating <seu-path>/fly.toml
Platform: machines
‚úì Configuration is valid
Your app is ready! Deploy with `flyctl deploy`
```

Agora o `flyctl` criou um arquivo `.dockerignore` que n√£o copia os arquivos do `.gitignore` para dentro do container docker e tamb√©m criou um arquivo de configura√ß√£o do Fly, o arquivo `fly.toml`.

Na √∫ltima linha ele nos disse que nossa aplica√ß√£o est√° pronta para o deploy. Mas ainda temos mais configura√ß√µes a fazer!

### Configura√ß√£o dos segredos

Para que nossa aplica√ß√£o funcione de maneira adequada, todas as vari√°veis de ambiente precisam estar configuradas no ambiente. O `flyctl` tem um comando para vermos as vari√°veis que j√° foram definidas no ambiente e tamb√©m para definir novas. O comando `secrets`.

Para vermos as vari√°veis j√° configuradas no ambiente, podemos executar o seguinte comando:

```shell title="$ Execu√ß√£o no terminal!"
flyctl secrets list

NAME        	DIGEST          	CREATED AT
DATABASE_URL	f803df294e7326fa	22m43s ago
```

Uma coisa que podemos notar na resposta do `secrets` √© que ele leu nosso arquivo `.env` e adicionou a vari√°vel de ambiente `DATABASE_URL` com base no postgres que foi criado durante o comando `launch`. Um ponto de aten√ß√£o que devemos tomar nesse momento, √© que a vari√°vel criada √© iniciada com o prefixo `postgres://`. Para que o sqlalchemy reconhe√ßa esse endere√ßo como v√°lido, o prefixo deve ser alterado para `postgresql://`. Para isso, usaremos a url fornecida pelo comando `launch` e alterar o prefixo.

Desta forma, podemos registar a vari√°vel de ambiente `DATABASE_URL` novamente. Agora com o valor correto:


```shell title="$ Execu√ß√£o no terminal!"
flyctl secrets set DATABASE_URL=postgresql://postgres:t0Vf35P21eDlIVS@fastzerodb.flycast:5432
Secrets are staged for the first deployment
```

Contudo, n√£o √© somente a vari√°vel de ambiente do postgres que √© importante para que nossa aplica√ß√£o seja executada. Temos que adicionar as outras vari√°veis contidas no nosso `.env` ao Fly.

Iniciaremos adicionando a vari√°vel `ALGORITHM`:

```shell title="$ Execu√ß√£o no terminal!"
flyctl secrets set ALGORITHM="HS256"
Secrets are staged for the first deployment
```

Seguida pela vari√°vel `SECRET_KEY`:

```shell title="$ Execu√ß√£o no terminal!"
flyctl secrets set SECRET_KEY="your-secret-key"
Secrets are staged for the first deployment
```

E por fim a vari√°vel `ACCESS_TOKEN_EXPIRE_MINUTES`:

```shell title="$ Execu√ß√£o no terminal!"
flyctl secrets set ACCESS_TOKEN_EXPIRE_MINUTES=30
Secrets are staged for the first deployment
```

Com isso, todos os segredos da nossa aplica√ß√£o j√° est√£o configurados no nosso ambiente do Fly. Agora podemos partir para o nosso t√£o aguardado deploy.


### Deploy da aplica√ß√£o

Para efetuarmos o deploy da aplica√ß√£o, podemos usar o comando `deploy` do`flyctl`. Uma coisa interessante nessa parte do processo √© que o Fly pode fazer o deploy de duas formas:

1. Copiar seus arquivos e fazer o build do docker na nuvem;
2. Voc√™ pode fazer o build localmente e subir apenas o container para um [reposit√≥rio](https://docs.docker.com/docker-hub/repos/){:target="_blank"} dispon√≠vel no Fly.

Optaremos por fazer o build localmente para n√£o serem alocadas duas m√°quinas em nossa aplica√ß√£o[^1]. Para executar o build localmente usamos a flag `--local-only`:

[^1]: No plano gratuito existe uma limita√ß√£o de m√°quinas dispon√≠veis por aplica√ß√£o. Quando usamos mais de uma m√°quina, temos que ter um plano pago, por esse motivo, faremos o build localmente.

```shell title="$ Execu√ß√£o no terminal!"
fly deploy --local-only
```

Como a resposta do comando `deploy` √© bastante grande, substituirei o texto por `...` para pular algumas linhas que n√£o nos interessam nesse momento:

```bash title="$ Resultado do comando `deploy`" hl_lines="22 28 31"
==> Verifying app config
Validating /home/dunossauro/ci-example-fastapi/fly.toml
Platform: machines
‚úì Configuration is valid
--> Verified app config
==> Building image
==> Building image with Docker
...
 => exporting to image                                                  0.0s
 => => exporting layers                                                 0.0s
 => => writing image sha256:b95a9d9f8abcea085550449a720a0bb9176e195fe4  0.0s
 => => naming to registry.fly.io/fastzeroapp:deployment-01HHKKDMF87FN4  0.0s
--> Building image done
==> Pushing image to fly
The push refers to repository [registry.fly.io/fastzeroapp]
...
deployment-01HHKKDMF87FN441VA6H0JR4BS: digest: sha256:153a13e2931f923ab60df7e9dd0f18e2cc89fff7833ac18443935c7d0763a329 size: 2419
--> Pushing image done
image: registry.fly.io/fastzeroapp:deployment-01HHKKDMF87FN441VA6H0JR4BS
image size: 349 MB

Watch your deployment at https://fly.io/apps/fastzeroapp/monitoring

-------
Updating existing machines in 'fastzeroapp' with rolling strategy

-------
 ‚úî Machine 1781551ad22489 [app] update succeeded
-------

Visit your newly deployed app at https://fastzeroapp.fly.dev/
```

As primeiras linhas da resposta est√£o relacionadas ao build do docker e a publica√ß√£o no reposit√≥rio de imagens docker do Fly.

Na sequencia, temos algumas informa√ß√µes importantes a respeito do deploy da nossa aplica√ß√£o. Como a URL de monitoramento (`https://fly.io/apps/<nome-do-app>/monitoring`), o aviso de que o deploy foi efetuado com sucesso (`Machine 1781551ad22489 [app] update succeeded`) e por fim, a URL de acesso a nossa aplica√ß√£o (`https://<nome-do-app>.fly.dev/`).

Dessa forma podemos acessar a nossa aplica√ß√£o acessando a URL fornecida pela √∫ltima linha de resposta em nosso browser, como `https://fastzeroapp.fly.dev/`:

![descri√ß√£o](assets/11_resposta_do_servidor.png){: .center .shadow }

E pronto, nossa aplica√ß√£o est√° dispon√≠vel para acesso! Obtivemos o nosso "Ol√° mundo". üöÄüöÄüöÄüöÄüöÄüöÄ

Por√©m, contudo, entretanto, ainda existe um problema na nossa aplica√ß√£o no ar. Para ficar evidente, tente acessar o swagger da sua aplica√ß√£o no ar e registrar um usu√°rio usando o endpoint `/user` com o m√©todo POST:

![descri√ß√£o](assets/11_erro_na_aplica√ß√£o_falta_de_migra√ß√£o.png){: .center .shadow width="800" }

Voc√™ receber√° uma mensagem de erro, um erro 500: `Internal Server Error`, por de n√£o efetuarmos a migra√ß√£o no banco de dados de produ√ß√£o. Por√©m, para ter certeza disso, podemos usar a URL de monitoramento do Fly para ter certeza do erro ocorrido. Acessando: `https://fly.io/apps/<nome-do-app>/monitoring`, podemos visualizar os erros exibidos no console da nossa aplica√ß√£o:

![descri√ß√£o](assets/11_erro_no_monitoramento.png){: .center .shadow }

Podemos ver no console a mensagem: `Relation "users" does not exist`. Que traduzida pode ser lido como `A rela√ß√£o "users" n√£o existe`. O significa que a tabela "users" n√£o foi criada ou n√£o existe no banco de dados.

Desta forma, para que nossa aplica√ß√£o funcione corretamente precisamos executar as migra√ß√µes.


### [REV] Migrations

Agora que nosso container j√° est√° em execu√ß√£o no fly, podemos executar o comando de migra√ß√£o dos dados, pois ele est√° na mesma rede do postgres configurado pelo Fly[^2]. Essa conex√£o √© feita via [SSH](https://en.wikipedia.org/wiki/Secure_Shell){:target="_blank"} e pode ser efetuada com o comando `ssh` do `flyctl`.

Podemos fazer isso de duas formas, acessando efetivamente o container remotamente ou enviando somente um comando para o Fly. Optarei pela segunda op√ß√£o, pois ela n√£o √© interativa e usar√° somente uma √∫nica chamada do shell. Desta forma:

[^2]: √â poss√≠vel executar a migra√ß√£o usando a sua m√°quina como ponto de partida. Para isso √© necess√°rio usar o proxy do Fly: `fly proxy 5432 -a fastzerodb`. Dessa forma, a porta 5432 √© disponibilizada localmente para executar o comando. Acredito, por√©m, que a conex√£o via ssh √© mais proveitosa, no momento em que podemos explorar mais uma forma de interagir com o Fly.

```shell title="$ Execu√ß√£o no terminal!" hl_lines="1"
flyctl ssh console -a fastzeroapp -C "poetry run alembic upgrade head"

Connecting to fdaa:2:77b0:a7b:1f60:3f74:a755:2... complete
Skipping virtualenv creation, as specified in config file.
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> e018397cecf4, create users table
INFO  [alembic.runtime.migration] Running upgrade e018397cecf4 -> de865434f506, create todos table
```

O comando `ssh` do `flyctl` √© um grupo de subcomandos para executar opera√ß√µes espec√≠ficas em um container. Podemos pedir os logs de certificado com `ssh log`, inserir ou recuperar arquivos via [FTP](https://en.wikipedia.org/wiki/File_Transfer_Protocol){:target="_blank"} com o `ssh ftp`.

O subcomando que utilizamos `ssh console` nos fornece acesso ao shell do container. Por isso tivemos que especificar com a flag `-a` o nome da nossa aplica√ß√£o (poder√≠amos acessar o console do banco de dados, tamb√©m). E a flag `-C` √© o comando que queremos que seja executado no console do container. Nesse caso, o comando completo representa: "Acesse o console do app fastzeroapp via SSH e execute o comando `poetry run alembic upgrade head`".

Dessa forma temos a migra√ß√£o sendo executada com sucesso. Voc√™ pode usar o comando `ssh console` sem especificar o comando tamb√©m, dessa forma ele far√° um login via ssh no container.

Com isso, podemos voltar ao swagger e tentar executar a opera√ß√£o de cria√ß√£o de um novo user com um POST no endpoit `/users`. Tudo deve ocorrer perfeitamente dessa vez:

> Adicionar print do swagger funcionando!

Agora, SIM, nossa aplica√ß√£o est√° em produ√ß√£o para qualquer pessoa poder usar e aproveitar da sua aplica√ß√£o. Mande o link para geral e veja o que as pessoas acham da sua mais nova aplica√ß√£o. üöÄ

## Commit

Agora que fizemos todas as altera√ß√µes necess√°rias, devemos adicionar ao nosso reposit√≥rio os arquivos criados pelo `flyctl launch`. Os arquivos `.dockerignore` e `fly.toml`:

```shell title="$ Execu√ß√£o no terminal!"
git add .
git commit -m "Adicionando arquivos gerados pelo Fly
git push
```

E pronto!

## [WIP] Conclus√£o

Assim, como prometido, chegamos ao final da jornada! Temos uma aplica√ß√£o pequena, mas funcional.

Nessa aula conhecemos um pouco sobre a plataforma Fly.io, aprendemos a fazer o deploy da nossa aplica√ß√£o em conjunto ao banco de dados e disponibilizamos ela para o mundo.
